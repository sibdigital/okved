<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <title>ОКВЭД</title>
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection">
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/materialize.min.js"></script>
    <style>
        .collection-header{
            border: 1px solid #e0e0e0;
            border-radius: 2px;
        }
        .collection-header:hover {
            background-color: rgba(38, 166, 154, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="input-field col s11">
                <input type="text" id="input-text" autocomplete="off"/>
                <label for="input-text">Введите сюда код или наименование из ОКВЭД</label>
            </div>
            <div class="input-field col s1">
                <button class="waves-effect waves-light btn" type="button" id="button-search">Найти</button>
            </div>
            <button class="waves-effect btn" type="button" id="button-add">Добавить новый ОКВЭД</button>
        </div>
        <div class="row">
            <div class="col s12" id="result2001">
                <div class="waves-effect waves-light collection-header col s12" id = "title2001" onclick="hide_okveds('2001')">ОКВЭД 2001</div>
                <div class="collection" id="c_2001"></div>
            </div>
            <div class="col s12" id="result2014">
                <div class="waves-effect waves-light collection-header col s12" id = "title2014" onclick="hide_okveds('2014')">ОКВЭД 2014</div>
                <div class="collection with-header" id="c_2014"></div>
            </div>
            <div class="col s12" id="resultSynt">
                <div class="waves-effect waves-light collection-header col s12" id = "titleSynt" onclick="hide_okveds('synt')">Синтетические ОКВЭДы</div>
                <div class="collection with-header" id="c_synt"></div>
            </div>
        </div>
    </div>
    <script>
        $('#button-search').click(function () {
            search();
        })

        function search() {
            $.get('/search', {text: $('#input-text').val()}, function (data) {
                showSearchResult(data);
            })
        }

        function clearCollection() {
            var collections = document.querySelectorAll('.collection');
            collections.forEach(function (node) {
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
            });
        }

        function addNothingFound(variables) {
            for (variable in variables){
                if (variables[variable]) {
                    var collection = $('#c_' + variable.substring(0, 4));
                    if (collection.length != 0) {
                        collection.append('<div><span>Ничего не найдено</span></div>');
                    }
                }
            }
        }

        function addFoundData(data) {
            var variables = {};
            data.forEach(function(element) {
                if (['2001', '2014', 'synt'].includes(element.version)) {
                    let item = $('<a>', {class: 'collection-item', href: '/okved?id=' + element.id,
                        target: '_blank', rel: 'noopener noreferrer',
                        text: element.kindCode + ' ' + element.kindName })
                    $('#c_' + element.version).append(item);
                    variables[element.version + "_is_empty"] = false;
                }

            });

            addNothingFound(variables);
        }

        function showSearchResult(data) {
            clearCollection();
            addFoundData(data);
        }


        $('#button-add').click(function () {
            window.open('/new_okved?okved_name=' + $('#input-text').val(), 'noopener', 'noreferrer');
        })

        function hide_okveds(version){
            let collection = $('#c_' + version);
            if (collection.is(":hidden")) {
                collection.slideDown();
            }
            else {
                collection.hide();
            }
        }

        $().ready(function () {
            search();
        })
    </script>
</body>
</html>